Resolve Decoding Problem and A Easy Technique Exploiting Leakage
==============================================================

##### 작성자: 컴퓨터 공학부 201601560 권혁모

# Foreword
이 글은 쉬운 수준의 파이선 문제 해결에 초점을 맞추어 작성되었습니다. 따라서 인코딩에 관하여 깊은 이해를 주지 않습니다. 또한 인코딩 문제는 까다롭습니다. 인코딩 문제에는 인코딩 자체 문제뿐만 아니라 파이선이 인코딩을 어떻게 다루는지도 포함되기에 복잡합니다. 또한 유니코드에 대한 이해도 필요합니다. 파이선의 유니코드 지원과 여기서 설명하는 문제와 같이 인코딩과 관련하여 작업할 떄 흔히 발생하는 문제에 대한 설명은 [Unicode HOWTO][Unicode HOWTO] 에서 추가적으로 읽어보실 수 있습니다. 인코딩에 관한 이해는 필수적이므로 프로그래머가 충분히 시간을 할애할 가치가 있습니다.

# Open function

```
open(file, mode='r', buffering=-1, encoding=None,
     errors=None, newline=None, closefd=True, opener=None) -> file object
```

_Note: 위에서 -> 표시는 함수 표현입니다. 수학에서 F: A -> B 표현과 유사하게 생각하실 수 있습니다._

PPT 자료에는 open 함수의 file, mode 인자밖에 나와있지 않지만 사실 open 은 훨씬 더 많은 인자를 가질 수 있습니다. open 함수의 정확한 signature 는 위와 같습니다. open 함수에 관해 더욱더 자세한 내용을 얻고 싶으시다면 [open function in builtins][open]에서 보실 수 있습니다.

# Decoding Problem

텍스트 모드로 파일을 열은 후 읽기 메서드를 호출할 때, 아래와 같은 에러를 만날 수 있습니다.

```
Traceback (most recent call last):
  File "<string>", line 301, in runcode
  File "<interactive input>", line 1, in <module>
UnicodeDecodeError: 'cp949' codec can't decode byte 0xed in position 27: illegal multibyte sequence
```

위와 같은 에러는 지정된 인코딩과 파일이 작성된 인코딩이 맞지 않아 발생합니다. 나는 인코딩을 지정하지 않았는데 왜 지정된 인코딩과 맞지 않아? 라고 생각하실 수 있습니다. 이러한 생각은 타당합니다. 코드 어디에서도 인코딩 관련된 내용이 없었으니까요.

open 함수의 signature 는 encoding 인자도 포함되어 있습니다. 이 인자가 파일을 읽을 때 어떤 인코딩을 사용하여 읽을지를 결정합니다. 만약 지금 상황에서와 같이 인코딩 인자를 open 함수에 넘겨 주지 않았다면, 어떤 인코딩으로 파일을 읽어야 할까요? 기본적으로 운영 체제가 이 인코딩을 결정합니다. 이 인코딩은 운영 체제가 기본적으로 사용하는 인코딩으로 **파일 시스템 인코딩**이라고 부릅니다.

흔히들 윈도우를 기본 운영 체제로 사용합니다. 윈도우에서는 기본 인코딩으로 cp949 를 사용합니다. 따라서 아무런 인코딩을 지정하지 않고 파일을 연다면 기본적으로 그 자리를 **cp949** 인코딩이 매꾸게 됩니다.

물론 윈도우를 운영 체제로 사용하지 않을 수 있습니다. 예로 벨 연구소에서는 Plan 9 을 운영 체제로 사용하기도 합니다. 이러한 경우에는 기본 인코딩이 다를 수 있으며 직접 검색해서 찾아보셔야 합니다. 그러나 아마도 높은 확률로 **utf-8** 을 쓰고 있을 겁니다.

그러나 파일은 utf-8 과 같이 다른 인코딩으로 쓰여졌을 수도 있습니다. 만약 파일이 cp949 가 아닌 인코딩으로 쓰여졌는데 cp949 인코딩으로 읽으려고 시도한다면 위와 같은 에러가 발생할 수 있습니다. 이런 에러를 해결하기 위해 다음 두 가지 방식을 고안할 수 있습니다.

1. 파일의 인코딩을 바꾼다.
2. open 인자에 파일에 맞는 인코딩을 넣어준다.

1 번 방식도 좋은 방식이지만 프로그래밍적으로 파일을 다루기 위해 2 번 방식을 사용하여 해결해본다면, open 코드 부분을 다음과 같은 코드를 수정하면 됩니다. 여기에서 작성된 파일은 utf-8 로 쓰여졌다고 가정했습니다.

```py
open(file, mode, buffering, 'utf-8')
open(file, mode, encoding='utf-8')
```

위 두 가지는 동등합니다. 괜시리 중간에 `buffering` 인자를 피하고 싶으시다면 후자의 방법이 선호됩니다. 후자의 방법을 [`keyword argument`][keyword argument] 라고 부릅니다.

이제 다시 파일을 읽는다면 에러없이 정상적으로 읽을 수 있을 것입니다.

# Forgot to close file object
프로그래머는 컴퓨터 자원을 사용하고, 사용 후 반드시 그 자원을 운영 체제에 반환해야 합니다. 이 반환이 제대로 이루어지지 않는다면 이것을 [**Resource Leak**][Resource Leak] 이라 부르며 프로그램 [버그][Software Bug]의 원인이 될 수 있습니다.

컴퓨터 자원에는 프로그래머가 사용한 파일도 해당됩니다. 즉 파이썬에서 open 함수로 파일을 열었다면 컴퓨터 자원을 사용한 것입니다. 따라서 반드시 이 자원이 더 이상 사용되지 않는다면 이 자원을 반환해야 합니다. 그러나 종종 프로그래머의 실수로 반환하는 것을 잊어먹는 경우가 발생합니다. 이를 [**FD Leak (File Descripter Leakage)**][FD Leak] 이라고 부릅니다.

그러나 파이썬은 똑똑하기 때문에, 프로그래머의 실수로 발생한 Resource Leak 을 종종 잡아내어 프로그래머를 대신해 이 자원을 반환할 수 있습니다. 간단한 Leak 을 해결할 수는 있지만, 존 모든 Leak 을 해결할 수 있는 것은 아닙니다.

보통 Leak 을 프로그램의 버그로 간주하지만 크게 문제가 되지 않는 경우 이를 활용하여 코드를 깔끔하게 작성할 수도 있습니다. 예로 아래와 같은 3 줄의 코드를

```python
f = open(...)
d = f.read()
f.close()
```
 
아래와 같이 FD Leak 을 동반하는 1 줄의 코드로 바꿀 수 있습니다.
 
```python
d = open(...).read()
```

위 코드는 Leak 을 수반하고 있지만 파이썬은 이 Leak 을 충분히 잡아낼 수 있습니다. 결과적으로 무사히 자원이 운영 체제로 반환됩니다. 여기서 자원이 반환되었으므로 열렸던 파일은 자동으로 닫힙니다.

> Just remember: it's often rare that we write our code and are the only ones who ever read it. Even if you're an export on all the ins and outs of JS, consider how a less experienced temmate of yours will feed when they read your code. Will it be "explicit" or "implicit" in the same way it is for you?
> 
> [You Don't Know JS][You Don't Know JS Type & Grammer Chapter 4]

그러나 이런 코드는 결코 권장할 만한 코드가 아닙니다. 위 인용문이 이러한 코드가 내포한 위험성 중 하나를 잘 설명하고 있습니다. 두 번째 이유로는 명시적인 반환 코드를 찾을 수 없으므로 디버깅에 부담이 될 것입니다.

파이썬은 이런 Leak 을 잡아 줄 수 있지만 이런 위험성 또한 역시 잘 알고 있습니다. 그래서 파이썬은 Leak 을 해결할 떄 마다 프로그래머에게 경고 메시지를 보냅니다. FD Leak 은 Resource Leak 중 하나 이므로 ResourceWarning 경고를 보냅니다.

경고는 에러와는 다릅니다. 파이썬 설정에 따라 다르지만, 기본 설정에서는 경고가 에러와는 다르게 프로그램의 실행을 멈추게 하진 않습니다. 그리고 경고는 화면에 나타나지 않습니다. 경고와 에러에 대해서는 각각 [여기][warnings]와 [여기][exceptions]에서 더 많은 내용을 보실 수 있습니다.

그렇다면 파이썬은 어떻게 해서 Resource Leak 을 알아차릴 수 있을까요? 그 비밀은 파이썬의 데이터 모델에 숨어 있습니다. 그러나 데이터 모델에 대한 내용은 이 글의 범위를 벗어납니다. 데이터 모델에 대한 더 많은 내용을 원하신다면 [object.__del__ in Data Model of Python][object.__del__] 을 참고하세요. 또한 그러한 데이터 모델이 어떻게 가능한 지에 대해서 간단한 설명을 원하신다면 [Py_DECREF][Py_DECREF], [Reference Counting][Reference Counting], [Main Ideas of CPython's Garbage Collector][Main Ideas of CPython's Garbage Collector] 에서 찾으실 수 있습니다.

# External links used in the above
1. https://docs.python.org/3/library/functions.html#open
1. https://docs.python.org/3/tutorial/errors.html
1. https://docs.python.org/3/tutorial/controlflow.html#keyword-arguments
1. https://docs.python.org/3/howto/unicode.html
1. https://docs.python.org/3/reference/datamodel.html#object.__del__
1. https://docs.python.org/3/c-api/refcounting.html#c.Py_DECREF
1. https://en.wikipedia.org/wiki/Reference_counting
1. https://www.quora.com/How-does-garbage-collection-in-Python-work
1. https://en.wikipedia.org/wiki/Resource_leak
1. http://www.dictionary.com/browse/file-descriptor-leak
1. https://en.wikipedia.org/wiki/Software_bug
1. https://github.com/getify/You-Dont-Know-JS/blob/master/types%20&%20grammar/ch4.md
1. https://docs.python.org/3/library/warnings.html
1. https://docs.python.org/3/reference/executionmodel.html#exceptions

[open]: https://docs.python.org/3/library/functions.html#open
[exception for tutorial]: https://docs.python.org/3/tutorial/errors.html
[keyword argument]: https://docs.python.org/3/tutorial/controlflow.html#keyword-arguments
[Unicode HOWTO]: https://docs.python.org/3/howto/unicode.html
[object.__del__]: https://docs.python.org/3/reference/datamodel.html#object.__del__
[Py_DECREF]: https://docs.python.org/3/c-api/refcounting.html#c.Py_DECREF
[Reference Counting]: https://en.wikipedia.org/wiki/Reference_counting
[Main Ideas of CPython's Garbage Collector]: https://www.quora.com/How-does-garbage-collection-in-Python-work
[Resource Leak]: https://en.wikipedia.org/wiki/Resource_leak
[FD Leak]: http://www.dictionary.com/browse/file-descriptor-leak
[Software Bug]: https://en.wikipedia.org/wiki/Software_bug
[You Don't Know JS Type & Grammer Chapter 4]: https://github.com/getify/You-Dont-Know-JS/blob/master/types%20&%20grammar/ch4.md
[warnings]: https://docs.python.org/3/library/warnings.html
[exceptions]: https://docs.python.org/3/reference/executionmodel.html#exceptions